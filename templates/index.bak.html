<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Audio Konvertierung</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f5f5f7;
            color: #1d1d1f;
            margin: 0;
            padding: 2em;
        }

        h1 { font-weight: 600; margin-bottom: 1em; }
        label { display: inline-block; margin: 0.5em 1em 0.5em 0; }
        input[type="text"] {
            padding: 0.5em;
            width: 50%;
            border: 1px solid #ccc;
            border-radius: 8px;
            background: #fff;
        }

        button {
            padding: 0.6em 1.2em;
            margin: 1em 0.5em 1em 0;
            border: none;
            border-radius: 10px;
            background: #007aff;
            color: white;
            font-size: 1em;
            cursor: pointer;
        }

        button:hover { background: #005fcc; }

        #progressBar {
            width: 100%;
            background: #d1d1d6;
            border-radius: 10px;
            margin-top: 1em;
            height: 20px;
        }

        #progressFill {
            height: 100%;
            background: #34c759;
            width: 0%;
            border-radius: 10px;
            transition: width 0.5s;
        }

        #statusText {
            margin-top: 0.5em;
            font-size: 0.9em;
            color: #555;
        }

        pre {
            background: #e5e5ea;
            padding: 1em;
            border-radius: 10px;
            height: 300px;
            overflow: auto;
            font-family: SFMono-Regular, monospace;
        }

        #subdir_container {
            margin: 1em 0;
            padding: 1em;
            background: #ffffff;
            border: 1px solid #ccc;
            border-radius: 10px;
        }
    </style>
    <script>
        let startTime = null;

        function loadSavedPaths() {
            document.getElementById('input_path').value =
                localStorage.getItem("input_path") || "/Volumes/Media Server/Upload/test";
            document.getElementById('output_path').value =
                localStorage.getItem("output_path") || "/Volumes/Media Server/Upload/output";
        }

        function savePaths() {
            localStorage.setItem("input_path", document.getElementById('input_path').value);
            localStorage.setItem("output_path", document.getElementById('output_path').value);
        }

        function togglePause() {
            fetch('/pause_toggle', { method: 'POST' });
        }

        function startTasks() {
            startTime = new Date();
            savePaths();

            const selectedSubdirs = Array.from(document.querySelectorAll('input[name="subdir"]:checked'))
                .map(cb => cb.value);

            const data = {
                input_path: document.getElementById('input_path').value,
                output_path: document.getElementById('output_path').value,
                selected_subdirs: selectedSubdirs,
                tasks: Array.from(document.querySelectorAll('input[name="task"]:checked')).map(e => e.value)
            };

            fetch('/start', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
        }

        function updateLog() {
            fetch('/progress')
                .then(r => r.json())
                .then(data => {
                    const log = data.log;
                    document.getElementById('log').textContent = log.join('\n');

                    const total = 100;
                    const current = Math.min(log.length, total);
                    const percent = Math.round((current / total) * 100);
                    document.getElementById('progressFill').style.width = percent + "%";

                    if (startTime && current > 0) {
                        const elapsed = (new Date() - startTime) / 1000;
                        const estimatedTotal = elapsed * (total / current);
                        const remaining = estimatedTotal - elapsed;
                        document.getElementById('statusText').textContent =
                            "Fortschritt: " + percent + "% | Verstrichen: " + formatTime(elapsed) +
                            " | Verbleibend: " + formatTime(remaining);
                    }
                });
        }

        function formatTime(sec) {
            sec = Math.max(0, Math.round(sec));
            const m = Math.floor(sec / 60);
            const s = sec % 60;
            return `${m}m ${s}s`;
        }

        function loadSubdirs() {
            const path = document.getElementById('input_path').value;
            fetch('/subdirs', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ path: path })
            })
            .then(r => r.json())
            .then(data => {
                const container = document.getElementById('subdir_container');
                container.innerHTML = '<strong>Unterordner ausw√§hlen:</strong><br>';
                data.subdirs.forEach(name => {
                    const id = `subdir_${name}`;
                    container.innerHTML += `
                        <label><input type="checkbox" name="subdir" value="${name}" id="${id}" checked> ${name}</label><br>
                    `;
                });
            });
        }

        window.onload = function() {
            loadSavedPaths();
            loadSubdirs();
            setInterval(updateLog, 1000);
        };
    </script>
</head>
<body>
    <h1>Audio Konvertierung</h1>

    <label for="input_path">Eingabeordner:</label><br>
    <input type="text" id="input_path" onchange="savePaths(); loadSubdirs();"><br><br>

    <label for="output_path">Ausgabeordner:</label><br>
    <input type="text" id="output_path" onchange="savePaths()"><br><br>

    <div id="subdir_container">Unterordner werden geladen...</div>

    <label><input type="checkbox" name="task" value="concat" checked> concat</label>
    <label><input type="checkbox" name="task" value="mp3_to_flac" checked> mp3_to_flac</label>
    <label><input type="checkbox" name="task" value="flac_to_mp3" checked> flac_to_mp3</label>
    <label><input type="checkbox" name="task" value="set_metadata" checked> set_metadata</label><br>

    <button onclick="startTasks()">Start</button>
    <button onclick="togglePause()">Pause / Fortsetzen</button>

    <div id="progressBar"><div id="progressFill"></div></div>
    <div id="statusText"></div>

    <pre id="log"></pre>
</body>
</html>
